<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>报文数据对比</title>
    <script src="css/maincss.css"></script>
    <script type="text/javascript" src="js/diff.min.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="css/diff2html.min.css" />
    <!-- Javascripts -->
    <script type="text/javascript" src="js/diff2html.min.js"></script>
    <script type="text/javascript" src="js/diff2html-ui.min.js"></script>

<!--    <script src="https://cdn.tailwindcss.com"></script>-->
<!--     <script src="https://cdnjs.cloudflare.com/ajax/libs/diff/5.0.0/diff.min.js"></script> -->
    <style>
        .d2h-code-side-linenumber{
            position: relative;
        }
        .diff-added { background-color: #dcfce7; }
        .diff-removed { background-color: #fee2e2; }
        .diff-modified { background-color: #fef9c3; }
        .json-key { color: #4a5568; font-weight: 600; }
        .json-string { color: #2b6cb0; }
        .json-number { color: #38a169; }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">报文对比平台</h1>

    <!-- 模式切换 -->
    <div class="mb-4 flex gap-4">
        <button id="modeToggle" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
            切换为不同报文模式
        </button>
    </div>

    <div class="grid grid-cols-2 gap-6">
        <!-- 环境A -->
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-xl font-semibold mb-4 text-red-600">环境A</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">请求URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="urlA" class="flex-1 p-2 border rounded"
                               placeholder="http://127.0.0.1:8080/api/requestA" onkeypress="urlAFillDefaultValue(event)" list="urlHistory">
                    </div>
                    <label class="block text-sm font-medium mb-1">请求头</label>
                    <div class="flex gap-2">
                        <input type="text" id="headerA" class="flex-1 p-2 border rounded"
                               placeholder='{"Content-Type": "application/json"}' onkeypress="headAFillDefaultValue(event)" list="urlHistory">
                    </div>
                </div>
                <div id="payloadSectionA" class="hidden">
                    <label class="block text-sm font-medium mb-1">专属请求报文</label>
                    <textarea id="payloadA" class="w-full p-2 border rounded h-40 font-mono " maxlength="10000"
                              placeholder='{"key": "value"}'></textarea>
                </div>
            </div>
        </div>

        <!-- 环境B -->
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-xl font-semibold mb-4 text-green-600">环境B</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">请求URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="urlB" class="flex-1 p-2 border rounded"
                               placeholder="http://127.0.0.1:8080/api/requestB" onkeypress="urlBFillDefaultValue(event)">
                    </div>
                    <label class="block text-sm font-medium mb-1">请求头</label>
                    <div class="flex gap-2">
                        <input type="text" id="headerB" class="flex-1 p-2 border rounded"
                               placeholder='{"Content-Type": "application/json"}' onkeypress="headBFillDefaultValue(event)" list="urlHistory">
                    </div>
                </div>
                <div id="payloadSectionB" class="hidden">
                    <label class="block text-sm font-medium mb-1">专属请求报文</label>
                    <textarea id="payloadB" class="w-full p-2 border rounded h-40 font-mono" maxlength="10000"
                              placeholder='{"key": "value"}'></textarea>
                </div>
            </div>
        </div>
    </div>
    <!-- 公共报文区域 -->
    <div id="commonPayloadSection" class="col-span-2 bg-white p-6 rounded-xl shadow-sm">
        <label class="block text-sm font-medium mb-1">公共请求报文</label>
        <textarea id="commonPayload" class="w-full p-2 border rounded h-40 font-mono"
                  placeholder='{"key": "value"}'></textarea>
    </div>

    <!-- 操作按钮 -->
    <div class="mt-6 flex justify-center mb-4 grid-cols-2 gap-20">
        <button onclick="sendRequests()"
                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
            执行对比测试
        </button>
        <button onclick="showOriginResult()" id="showOriginResultBtn"
                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
            展示原始结果
        </button>
    </div>

    <!-- 对比结果框 -->
    <div id="diffResultContent" class="col-span-2 bg-white p-6 h-96 rounded-xl shadow-sm overflow-auto">
        <h3 class="text-lg font-semibold mb-4 text-center">对比结果</h3>
    </div>

    <!-- 原始返回展示框 -->
    <div class="mt-8 grid grid-cols-2 gap-6 hidden" id="originalResponseShow">
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold mb-4">请求A响应原始结果</h3>
            <pre id="responseA" class="h-96 overflow-auto font-mono text-sm p-4 bg-gray-50 rounded"></pre>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold mb-4">请求B响应原始结果</h3>
            <pre id="responseB" class="h-96 overflow-auto font-mono text-sm p-4 bg-gray-50 rounded"></pre>
        </div>
    </div>

    <!-- 数据库配置 -->
    <div class="mt-8 grid grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold mb-4">环境A数据库配置</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">JDBC URL</label>
                    <input type="text" id="jdbcUrlA" class="w-full p-2 border rounded">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">用户名</label>
                        <input type="text" id="dbUserA" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">密码</label>
                        <input type="password" id="dbPasswordA" class="w-full p-2 border rounded">
                    </div>
                </div>
                <button onclick="connectDatabase('A')"
                        class="w-full py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                    连接环境A数据库
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold mb-4">环境B数据库配置</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">JDBC URL</label>
                    <input type="text" id="jdbcUrlB" class="w-full p-2 border rounded">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">用户名</label>
                        <input type="text" id="dbUserB" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">密码</label>
                        <input type="password" id="dbPasswordB" class="w-full p-2 border rounded">
                    </div>
                </div>
                <button onclick="connectDatabase('B')"
                        class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                    连接环境B数据库
                </button>
            </div>
        </div>
    </div>
</div>

<script>
        let isSamePayload = true;
        let formattedResponses = { A: null, B: null };
        let differences = {};
        let isShowOriginResult = false;

        // 展示原始结果
        function showOriginResult() {
            isShowOriginResult = !isShowOriginResult;
            document.getElementById('originalResponseShow').classList.toggle('hidden');
            if (isShowOriginResult) {
                document.getElementById('showOriginResultBtn').innerHTML = '隐藏原始结果';
            } else {
                document.getElementById('showOriginResultBtn').innerHTML = '展示原始结果';
            }
        }

        // 初始化URL历史
        // fetch('/api/url-history')
        //     .then(r => r.json())
        //     .then(urls => {
        //         const datalist = document.getElementById('urlHistory');
        //         urls.forEach(url => {
        //             const option = document.createElement('option');
        //             option.value = url;
        //             datalist.appendChild(option);
        //         });
        //     });

        // 模式切换
        document.getElementById('modeToggle').addEventListener('click', () => {
            isSamePayload = !isSamePayload;
            document.getElementById('modeToggle').textContent =
                isSamePayload ? '切换为不同报文模式' : '切换为相同报文模式';

            document.getElementById('commonPayloadSection').classList.toggle('hidden');
            document.getElementById('payloadSectionA').classList.toggle('hidden');
            document.getElementById('payloadSectionB').classList.toggle('hidden');

            if (isSamePayload) {
                document.getElementById('payloadA').value = document.getElementById('commonPayload').value;
                document.getElementById('payloadB').value = document.getElementById('commonPayload').value;
            }
        });

        async function sendRequests() {
            const payload = {
                urlA: document.getElementById('urlA').value,
                urlB: document.getElementById('urlB').value,
                headerA: document.getElementById('headerA').value,
                headerB: document.getElementById('headerB').value,
                payloadA: isSamePayload ?
                    document.getElementById('commonPayload').value :
                    document.getElementById('payloadA').value,
                payloadB: isSamePayload ?
                    document.getElementById('commonPayload').value :
                    document.getElementById('payloadB').value
            }

            try {
                    payloadAJson = JSON.parse(payload.payloadA);
                    payloadBJson = JSON.parse(payload.payloadB);

                    payload.payloadA = JSON.stringify(payloadAJson);
                    payload.payloadB = JSON.stringify(payloadBJson);
                } catch (error) {
                    window.alert('输入报文含有非法json字符串', error);
                }

            try {
                const response = await fetch('/api/send-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json(); 
                formattedResponses = { A: result.resultA, B: result.resultB};
                differences = JsDiff.createTwoFilesPatch('resutl-A', 'result-B', reponseFormat(formattedResponses.A), reponseFormat(formattedResponses.B));
                displayResponses(differences);
            } catch (error) {
                console.error('请求失败:', error);
            }
        }

        function displayResponses(diff) {
            const responseA = document.getElementById('responseA');
            const responseB = document.getElementById('responseB');
            const diffResultContent = document.getElementById('diffResultContent');

            responseA.innerHTML = reponseFormat(formattedResponses.A);
            responseB.innerHTML = reponseFormat(formattedResponses.B);

            diffResultContent.innerHTML = Diff2Html.html(diff, {
                inputFormat: "diff",
                showFiles: false,
                drawFileList: false,
                diffStyle: "char",
                matching: "lines",
                highlight: true,
                outputFormat: "side-by-side",
                stickyFileHeaders: false
            });

            // const configuration = { drawFileList: true, matching: 'lines', highlight: true, outputFormat: "side-by-side", synchronisedScroll: true };
            // const diff2htmlUi = new Diff2HtmlUI(diffResultContent, diff, configuration);
            // diff2htmlUi.draw();
            // diff2htmlUi.highlightCode();
        }

        function headAFillDefaultValue(event) {
            if (event.key === 'Enter') {
            document.getElementById("headerA").value = '{"Content-Type": "application/json"}';
            event.preventDefault(); // 防止表单提交
            }
        }
        
        function headBFillDefaultValue(event) {
            if (event.key === 'Enter') {
            document.getElementById("headerB").value = '{"Content-Type": "application/json"}';
            event.preventDefault(); // 防止表单提交
            }
        }  

        function urlAFillDefaultValue(event) {
            if (event.key === 'Enter') {
            document.getElementById("urlA").value = 'http://127.0.0.1:8080/api/requestA';
            event.preventDefault(); // 防止表单提交
            }
        }

        function urlBFillDefaultValue(event) {
            if (event.key === 'Enter') {
            document.getElementById("urlB").value = 'http://127.0.0.1:8080/api/requestB';
            event.preventDefault(); // 防止表单提交
            }
        }

        function reponseFormat(json) {
            let jsonObject = JSON.parse(json);
            let formattedJson = JSON.stringify(jsonObject, null, 4);
            console.log(formattedJson);
            return formattedJson;
        }


        function syntaxHighlight(json) {
            const jsonString = JSON.stringify(json, null, 2);
            return jsonString.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                match => {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        cls = /:$/.test(match) ? 'json-key' : 'json-string';
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return `<span class="${cls}">${match}</span>`;
                });
        }

        function syntaxHighlightWithDiff(json, diffs) {
            const jsonString = JSON.stringify(json, null, 2);
            const lines = jsonString.split('\n');
            const diff = Diff.createTwoFilesPatch('A', 'B', jsonString, showResonse(diffs), null, null, { context: 0 });

            return lines.map((line, index) => {
                const diffLine = diff.split('\n')[index + 3]; // Skip the first three lines of the diff output
                if (diffLine.startsWith('+')) {
                    return `<div class="diff-added">${syntaxHighlight(line)}</div>`;
                } else if (diffLine.startsWith('-')) {
                    return `<div class="diff-removed">${syntaxHighlight(line)}</div>`;
                } else if (diffLine.startsWith('!')) {
                    return `<div class="diff-modified">${syntaxHighlight(line)}</div>`;
                }
                return `<div>${syntaxHighlight(line)}</div>`;
        }).join('\n');
    }

        function sortKeys(obj) {
            if (typeof obj !== 'object' || obj === null) return obj;
            return Object.keys(obj).sort().reduce((acc, key) => {
                acc[key] = sortKeys(obj[key]);
                return acc;
            }, {});
        }

        async function connectDatabase(env) {
            const config = {
                env: env,
                url: document.getElementById(`jdbcUrl${env}`).value,
                username: document.getElementById(`dbUser${env}`).value,
                password: document.getElementById(`dbPassword${env}`).value
            };

            const response = await fetch('/api/connect-db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                body: JSON.stringify(config)
            });

            const result = await response.json();
            alert(result.status === 'success' ? `环境${env}数据库连接成功` : `连接失败: ${result.message}`);
        }
    </script>
</body>
</html>